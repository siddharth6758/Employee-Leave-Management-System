{% extends 'index.html' %}
{% load static %}

{% block title %}
  <title>Dashboard</title>
{% endblock %}

{% block main_content %}
  <div class="dashboard-container">
    <!-- =========== HEADER =========== -->
    <header class="dashboard-header">
      <div>Hi, {{ request.user.first_name|default:request.user.username }}!</div>
      <div class="header-actions">
        {% if is_manager %}
          <a href="{% url 'delegate_apply' %}"><button id="choose-delegate-btn" class="btn-primary">Choose Delegate</button></a>
        {% endif %}
        <form method="post" action="{% url 'logout' %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn-primary">Logout</button>
        </form>
      </div>
    </header>

    <!-- =========== MAIN PANEL =========== -->
    <div class="main-panel">
      <div>
        <a href="{% url 'apply_leave_request' %}"><button id="apply-leave" class="btn-primary">Apply</button></a>
        <a href="{% url 'leave_status' %}"><button id="leave-status-history"> Status/History</button></a>
      </div>

      <!-- Leave Balance Cards -->
      <div class="leave-balances" style="margin-top: 1rem;">
        <div>
          <p>Sick</p>
          <h3>{{ leave_balance.sick|default:'0' }}</h3>
        </div>
        <div>
          <p>Casual</p>
          <h3>{{ leave_balance.casual|default:'0' }}</h3>
        </div>
        <div>
          <p>Earned</p>
          <h3>{{ leave_balance.earned|default:'0' }}</h3>
        </div>
      </div>

      <!-- =========== Manager and Delegate =========== -->
      <div class="manager-section">
        {% if is_manager %}
          <!-- Manager's View of Pending Requests -->
          <div class="leave-requests-header">
            <h4>Leave Requests</h4>
            <a href="{% url 'leave_report' %}"><button id="download-report" class="btn-primary">Leave Report</button></a>
          </div>
          <div>
            <!-- This part should be looped with actual data from your view -->
            {% for leave_request in pending_leave_requests %}
              <div class="leave-request-item"
                id="leave-request-{{ leave_request.id }}"
                data-id="{{ leave_request.id }}"
                data-employee="{{ leave_request.employee.get_full_name|default:leave_request.employee.username }}"
                data-type="{{ leave_request.get_leave_type_display }}"
                data-start="{{ leave_request.start_date|date:'Y-m-d' }}"
                data-end="{{ leave_request.end_date|date:'Y-m-d' }}"
                data-reason="{{ leave_request.reason }}"
                style="cursor: pointer;">
                <span><strong>Name:</strong> {{ leave_request.employee.username }} <strong>From:</strong> {{ leave_request.start_date }} <strong>To:</strong> {{ leave_request.end_date }}</span>
                <div class="approval-buttons">
                  <button class="approve-btn" data-id="{{leave_request.id}}"><i class="fa-solid fa-circle-check"></i></button>
                  <button class="reject-btn" data-id="{{leave_request.id}}"><i class="fa-solid fa-circle-xmark"></i></button>
                </div>
              </div>
            {% empty %}
              <p>No pending requests.</p>
            {% endfor %}
          </div>
        {% elif is_delegated_manager %}
          <!-- Delegate's View of Pending Requests -->
          <div class="leave-requests-header">
            <h4>Delegated Leave Requests</h4>
          </div>
          <div>
            {% for delegated_leave in delegated_requests %}
              <div class="leave-request-item"
                id="leave-request-{{ delegated_leave.id }}"
                data-id="{{ delegated_leave.id }}"
                data-employee="{{ delegated_leave.employee.get_full_name|default:delegated_leave.employee.username }}"
                data-type="{{ delegated_leave.get_leave_type_display }}"
                data-start="{{ delegated_leave.start_date|date:'Y-m-d' }}"
                data-end="{{ delegated_leave.end_date|date:'Y-m-d' }}"
                data-reason="{{ delegated_leave.reason }}"
                style="cursor: pointer;">
                <span>{{ delegated_leave.employee.username }} - {{ delegated_leave.start_date }} to {{ delegated_leave.end_date }}</span>
                <div class="approval-buttons">
                  <button class="approve-btn" data-id="{{delegated_leave.id}}"><i class="fa-solid fa-circle-check"></i></button>
                  <button class="reject-btn" data-id="{{delegated_leave.id}}"><i class="fa-solid fa-circle-xmark"></i></button>
                </div>
              </div>
            {% empty %}
              <p>No delegated requests to approve.</p>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}
